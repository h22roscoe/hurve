<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Hurve Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* Dark theme colours */
      --bg: #0b0d12;
      --fg: #e8eef8;
      --muted: #94a3b8;
      --accent: #22d3ee;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
    }

    .wrap {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    header {
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid #1f2937;
    }

    header input {
      padding: 4px 8px;
      border: 1px solid #374151;
      border-radius: 6px;
      background: #111827;
      color: var(--fg);
    }

    header button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: var(--accent);
      color: #000;
      cursor: pointer;
    }

    main {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .room {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #0f172a;
      border-radius: 6px;
      padding: 8px 12px;
    }

    .room button {
      margin-left: auto;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      background: var(--accent);
      color: #000;
      cursor: pointer;
    }

    footer {
      padding: 10px 12px;
      border-top: 1px solid #1f2937;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <strong>Hurve Lobby</strong>
      <label>Name: <input id="displayName" type="text" placeholder="Your name" /></label>
      <button id="createRoom">Create Room</button>
      <button id="refreshRooms">Refresh</button>
    </header>
    <main id="roomsList">
      <!-- Rooms will appear here -->
    </main>
    <footer>
      Select a room to play Curve Fever. Use the controls in game: left/right arrows (or A/D) to turn.
    </footer>
  </div>
  <script>
    async function fetchRooms() {
      try {
        const res = await fetch('/rooms');
        if (!res.ok) return [];
        return await res.json();
      } catch (err) {
        console.error('Failed to fetch rooms', err);
        return [];
      }
    }
    function renderRooms(rooms) {
      const list = document.getElementById('roomsList');
      list.innerHTML = '';
      if (!rooms || rooms.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'No rooms available. Create one!';
        list.appendChild(p);
        return;
      }
      rooms.forEach(room => {
        const div = document.createElement('div');
        div.className = 'room';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = 'Room ' + (room.roomId ? String(room.roomId).slice(0, 8) : '');
        const statusSpan = document.createElement('span');
        statusSpan.textContent = '(' + (room.status || 'Waiting') + ')';
        const playersSpan = document.createElement('span');
        const playersCount = room.players && Array.isArray(room.players) ? room.players.length : 0;
        const maxPlayers = room.maxPlayers || 8;
        playersSpan.textContent = playersCount + '/' + maxPlayers;
        const joinBtn = document.createElement('button');
        joinBtn.textContent = 'Join';
        joinBtn.onclick = () => joinRoom(room.roomId);
        div.appendChild(nameSpan);
        div.appendChild(statusSpan);
        div.appendChild(playersSpan);
        div.appendChild(joinBtn);
        list.appendChild(div);
      });
    }
    async function refreshRooms() {
      const rooms = await fetchRooms();
      renderRooms(rooms);
    }
    async function createRoom() {
      const req = { name: 'Room', maxPlayers: 8, isPrivate: false };
      try {
        const res = await fetch('/rooms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(req)
        });
        if (res.ok) {
          const data = await res.json();
          // immediately join the new room
          await joinRoom(data.roomId);
        }
      } catch (err) {
        console.error('Failed to create room', err);
      }
    }
    async function joinRoom(roomId) {
      const nameInput = document.getElementById('displayName');
      let displayName = nameInput.value.trim();
      if (!displayName) displayName = 'Guest';
      try {
        const res = await fetch('/rooms/' + roomId + '/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ displayName })
        });
        if (res.ok) {
          const data = await res.json();
          // Redirect to the room page with the roomId and token in the query string.
          // Do NOT pass the wsUrl returned from the server here. The wsUrl includes
          // type names ("RoomId", "JoinToken") in its path because Haskell's
          // Show instance for newtypes prints them with their constructor names.
          // That makes the URL invalid for our websocket router. Instead we only
          // pass the raw roomId and token and let the room page compute the
          // WebSocket URL correctly.
          const params = new URLSearchParams();
          params.set('roomId', roomId);
          params.set('token', data.token);
          window.location.href = 'room.html?' + params.toString();
        } else {
          console.error('Failed to join room', res.status);
        }
      } catch (err) {
        console.error('Failed to join room', err);
      }
    }
    document.getElementById('createRoom').addEventListener('click', createRoom);
    document.getElementById('refreshRooms').addEventListener('click', refreshRooms);
    document.addEventListener('DOMContentLoaded', refreshRooms);
  </script>
</body>

</html>
